name: frpQuarto
title: "FRP Manuscript Format"
author: "Dr. Peter Fromberger"
version: 0.1.5
quarto-required: ">=1.5.0"

contributes:

  shortcodes: 
    - summary.lua
    - acknowledgements.lua
    - contributors.lua
    - datasharing_statement.lua
    - declaration_of_interests.lua
    - panel.lua
    - andrew-heiss-count-words.lua # Credits to andrew heiss: https://github.com/andrewheiss/quarto-wordcount/

  format:

    html:
      theme: [default, styles.scss]
      html-table-processing: none
      tbl-cap-location: bottom
      toc: true
      toc-depth: 3
      toc-expand: false

      template: template.html

      citeproc: false

      filters:
        - at: pre-quarto
          path: citeproc.lua
        - at: pre-quarto
          path: wordcount.lua
      
      include-after-body:
        text: |
              <script>
                document.addEventListener("DOMContentLoaded", () => {

                  /* --------------------------------------------------
                  * 1. FIGCAPTION TRANSFORMATION
                  * -------------------------------------------------- */
                  document.querySelectorAll("figcaption").forEach(e => {
                    e.innerHTML = e.innerHTML.replace(
                      /((.*?)\.)\s*(.*)/,
                      '<div class="figcaption-title-lancet">$1</div>' +
                      '<details class="dropdown-card">' +
                        '<summary>' +
                          '<span class="figcaption-dropdown">Show full caption</span>' +
                          '<span class="arrow">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">' +
                              '<polyline points="6 9 12 15 18 9"/>' +
                            '</svg>' +
                          '</span>' +
                        '</summary>' +
                        '<div class="figcaption-subtext">$3</div>' +
                      '</details>'
                    );
                  });

                  /* --------------------------------------------------
                  * 2. WORDCOUNT â†’ TOC SIDEBAR
                  * -------------------------------------------------- */
                  const source = document.querySelector(".wordcount-source");
                  const toc = document.querySelector("nav#TOC, nav[id$='TOC']");

                  if (source && toc) {
                    const container = document.createElement("div");
                    container.classList.add(
                      "add-info",
                      "content-visible",
                      "no-count"
                    );

                    container.innerHTML = source.innerHTML;

                    const tocContent = toc.querySelector(".toc-content") || toc;
                    tocContent.after(container);
                  }

                });
              </script>

      crossref:
        title-delim: " "

      template-partials:
        - title-block.html
        - toc.html
    docx:
      reference-docx: styles.docx
      output-file: manuscript_docx.docx